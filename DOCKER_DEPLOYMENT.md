# Dockeréƒ¨ç½²æŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

ç¡®ä¿ç³»ç»Ÿå·²å®‰è£…ä»¥ä¸‹è½¯ä»¶ï¼š
- Docker (>= 20.10)
- Docker Compose (>= 2.0)

```bash
# æ£€æŸ¥ç‰ˆæœ¬
docker --version
docker-compose --version
```

### 2. ä¸€é”®éƒ¨ç½²

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd aiVideo

# æ‰§è¡Œéƒ¨ç½²è„šæœ¬
chmod +x scripts/docker/deploy.sh
./scripts/docker/deploy.sh
```

### 3. è®¿é—®æœåŠ¡

éƒ¨ç½²å®Œæˆåï¼Œå¯ä»¥è®¿é—®ä»¥ä¸‹æœåŠ¡ï¼š

| æœåŠ¡ | åœ°å€ | è¯´æ˜ |
|------|------|------|
| APIæœåŠ¡ | http://localhost:8000 | ä¸»è¦APIæ¥å£ |
| APIæ–‡æ¡£ | http://localhost:8000/docs | Swaggeræ–‡æ¡£ |
| Flowerç›‘æ§ | http://localhost:5555 | Celeryä»»åŠ¡ç›‘æ§ |
| MinIOå­˜å‚¨ | http://localhost:9001 | å¯¹è±¡å­˜å‚¨ç®¡ç† |

## ğŸ“‹ éƒ¨ç½²é€‰é¡¹

### åŸºç¡€éƒ¨ç½²
```bash
./scripts/docker/deploy.sh
```

### åŒ…å«Nginxåå‘ä»£ç†
```bash
./scripts/docker/deploy.sh --with-nginx
```

### åŒ…å«ç›‘æ§æœåŠ¡
```bash
./scripts/docker/deploy.sh --with-monitoring
```

## ğŸ”§ æœåŠ¡ç®¡ç†

ä½¿ç”¨ç®¡ç†è„šæœ¬è¿›è¡Œæ—¥å¸¸è¿ç»´ï¼š

```bash
chmod +x scripts/docker/manage.sh

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
./scripts/docker/manage.sh status

# æŸ¥çœ‹æ—¥å¿—
./scripts/docker/manage.sh logs          # æ‰€æœ‰æœåŠ¡
./scripts/docker/manage.sh logs api     # ç‰¹å®šæœåŠ¡

# é‡å¯æœåŠ¡
./scripts/docker/manage.sh restart      # æ‰€æœ‰æœåŠ¡
./scripts/docker/manage.sh restart api  # ç‰¹å®šæœåŠ¡

# å¥åº·æ£€æŸ¥
./scripts/docker/manage.sh health

# å¤‡ä»½æ•°æ®
./scripts/docker/manage.sh backup

# æ›´æ–°æœåŠ¡
./scripts/docker/manage.sh update
```

## ğŸ—ï¸ æ¶æ„è¯´æ˜

### æœåŠ¡ç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Nginx (å¯é€‰)                         â”‚
â”‚                  åå‘ä»£ç† + è´Ÿè½½å‡è¡¡                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  AI Video API                          â”‚
â”‚              FastAPI + æ™ºèƒ½è§†é¢‘å¤„ç†                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Celery Workers                        â”‚
â”‚                å¼‚æ­¥ä»»åŠ¡å¤„ç† (2å®ä¾‹)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Redis                               â”‚
â”‚              æ¶ˆæ¯é˜Ÿåˆ— + ç»“æœå­˜å‚¨                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   MinIO                                â”‚
â”‚                 å¯¹è±¡å­˜å‚¨æœåŠ¡                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Flower + Prometheus + Grafana              â”‚
â”‚                ç›‘æ§å’Œå¯è§†åŒ– (å¯é€‰)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç½‘ç»œé…ç½®

- è‡ªå®šä¹‰ç½‘ç»œï¼š`ai-video-network` (172.20.0.0/16)
- æœåŠ¡é—´é€šä¿¡é€šè¿‡æœåŠ¡åè§£æ
- å¤–éƒ¨è®¿é—®é€šè¿‡ç«¯å£æ˜ å°„

### æ•°æ®æŒä¹…åŒ–

| å·åç§° | æŒ‚è½½ç‚¹ | è¯´æ˜ |
|--------|--------|------|
| redis_data | /data | Redisæ•°æ®æŒä¹…åŒ– |
| minio_data | /data | MinIOå¯¹è±¡å­˜å‚¨ |
| prometheus_data | /prometheus | ç›‘æ§æ•°æ® |
| grafana_data | /var/lib/grafana | ä»ªè¡¨æ¿é…ç½® |

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

å¤åˆ¶å¹¶ä¿®æ”¹ç¯å¢ƒé…ç½®ï¼š
```bash
cp env.example .env
```

ä¸»è¦é…ç½®é¡¹ï¼š

```bash
# APIé…ç½®
API_HOST=0.0.0.0
API_PORT=8000

# Redisé…ç½®
REDIS_HOST=redis
REDIS_PORT=6379

# Celeryé…ç½®
CELERY_BROKER_URL=redis://redis:6379/0
CELERY_RESULT_BACKEND=redis://redis:6379/1

# MinIOé…ç½®
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=minioadmin123
```

### æ€§èƒ½è°ƒä¼˜

#### Workerå¹¶å‘æ•°
```yaml
# docker-compose.yml
deploy:
  replicas: 2  # Workerå®ä¾‹æ•°é‡
```

#### å†…å­˜é™åˆ¶
```yaml
services:
  api:
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
```

#### æ–‡ä»¶ä¸Šä¼ å¤§å°
```yaml
# nginx/nginx.conf
client_max_body_size 1G;
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç«¯å£å†²çª**
   ```bash
   # æ£€æŸ¥ç«¯å£å ç”¨
   lsof -i :8000
   
   # ä¿®æ”¹docker-compose.ymlä¸­çš„ç«¯å£æ˜ å°„
   ports:
     - "8001:8000"  # æ”¹ä¸º8001
   ```

2. **ç£ç›˜ç©ºé—´ä¸è¶³**
   ```bash
   # æ¸…ç†Dockerèµ„æº
   ./scripts/docker/manage.sh cleanup
   
   # æ¸…ç†åŒ…æ‹¬æ•°æ®å·ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
   ./scripts/docker/manage.sh cleanup --volumes
   ```

3. **æœåŠ¡å¯åŠ¨å¤±è´¥**
   ```bash
   # æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
   ./scripts/docker/manage.sh logs [service_name]
   
   # é‡å¯æœåŠ¡
   ./scripts/docker/manage.sh restart [service_name]
   ```

4. **å¥åº·æ£€æŸ¥å¤±è´¥**
   ```bash
   # æ‰§è¡Œå¥åº·æ£€æŸ¥
   ./scripts/docker/manage.sh health
   
   # æ‰‹åŠ¨æµ‹è¯•API
   curl http://localhost:8000/health
   ```

### æ—¥å¿—æŸ¥çœ‹

```bash
# å®æ—¶æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose logs -f api

# æŸ¥çœ‹æœ€è¿‘100è¡Œæ—¥å¿—
docker-compose logs --tail=100 api
```

### æ•°æ®æ¢å¤

```bash
# ä»å¤‡ä»½æ¢å¤
cp -r backup/20231201_120000/* ./

# é‡å¯æœåŠ¡
docker-compose restart
```

## ğŸ” å®‰å…¨é…ç½®

### ç”Ÿäº§ç¯å¢ƒå»ºè®®

1. **ä¿®æ”¹é»˜è®¤å¯†ç **
   ```bash
   # .envæ–‡ä»¶
   MINIO_ROOT_PASSWORD=your_secure_password
   FLOWER_BASIC_AUTH=your_user:your_password
   ```

2. **å¯ç”¨HTTPS**
   ```bash
   # ç”ŸæˆSSLè¯ä¹¦
   openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
     -keyout nginx/ssl/key.pem -out nginx/ssl/cert.pem
   
   # å¯ç”¨Nginx
   ./scripts/docker/deploy.sh --with-nginx
   ```

3. **ç½‘ç»œéš”ç¦»**
   ```yaml
   # ç§»é™¤ä¸å¿…è¦çš„ç«¯å£æ˜ å°„
   # ports:
   #   - "6379:6379"  # Redisä¸å¯¹å¤–æš´éœ²
   ```

4. **èµ„æºé™åˆ¶**
   ```yaml
   deploy:
     resources:
       limits:
         cpus: '2.0'
         memory: 4G
   ```

## ğŸ“Š ç›‘æ§é…ç½®

### å¯ç”¨ç›‘æ§
```bash
./scripts/docker/deploy.sh --with-monitoring
```

### è®¿é—®ç›‘æ§æœåŠ¡
- Prometheus: http://localhost:9090
- Grafana: http://localhost:3000 (admin/admin123)

### è‡ªå®šä¹‰æŒ‡æ ‡

åœ¨APIä¸­æ·»åŠ PrometheusæŒ‡æ ‡ï¼š
```python
from prometheus_client import Counter, Histogram

REQUEST_COUNT = Counter('api_requests_total', 'Total API requests')
REQUEST_DURATION = Histogram('api_request_duration_seconds', 'API request duration')
```

## ğŸš€ ç”Ÿäº§éƒ¨ç½²

### ç¡¬ä»¶è¦æ±‚

| ç»„ä»¶ | æœ€å°é…ç½® | æ¨èé…ç½® |
|------|----------|----------|
| CPU | 2æ ¸ | 4æ ¸+ |
| å†…å­˜ | 4GB | 8GB+ |
| å­˜å‚¨ | 20GB | 100GB+ SSD |
| ç½‘ç»œ | 100Mbps | 1Gbps |

### éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- [ ] SSLè¯ä¹¦é…ç½®ï¼ˆå¦‚éœ€è¦ï¼‰
- [ ] é˜²ç«å¢™è§„åˆ™è®¾ç½®
- [ ] æ•°æ®å¤‡ä»½ç­–ç•¥
- [ ] ç›‘æ§å‘Šè­¦é…ç½®
- [ ] æ—¥å¿—è½®è½¬é…ç½®
- [ ] èµ„æºé™åˆ¶è®¾ç½®

### æ‰©å®¹ç­–ç•¥

1. **æ°´å¹³æ‰©å®¹Worker**
   ```yaml
   deploy:
     replicas: 4  # å¢åŠ Workerå®ä¾‹
   ```

2. **APIè´Ÿè½½å‡è¡¡**
   ```yaml
   api:
     deploy:
       replicas: 2
   ```

3. **Redisé›†ç¾¤**
   ```yaml
   # ä½¿ç”¨Redis Clusteræˆ–Sentinel
   ```

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0
- åˆå§‹DockeråŒ–éƒ¨ç½²
- æ”¯æŒAPIã€Workerã€Redisã€MinIO
- åŒ…å«ç›‘æ§å’Œåå‘ä»£ç†é…ç½®
- æä¾›å®Œæ•´çš„ç®¡ç†è„šæœ¬
